# vim: ft=make noexpandtab

# normalize rubyarchdir which is not available depending on rake or gem
narchdir = $(if $(rubyarchdir),$(rubyarchdir),$(RUBYARCHDIR))

# hack for RubyGems >= 1.8.26
final_archdir = $(if $(findstring .gem.,$(narchdir)),$(dir $(narchdir)),$(narchdir))

INSTALL_DATA = $(realpath $(final_archdir))/prestogres

PGPOOL2_PATH = $(realpath $(srcdir)/../pgpool2)

CFLAGS += -DPRESTOGRES_PREFIX="\"$(INSTALL_DATA)\""

all: pgpool2

clean: clean-pgpool2

install: install-pgpool2

pgpool2:
	mkdir -p build
	cd build && "$(PGPOOL2_PATH)/configure" \
		CFLAGS="-I$(PGPOOL2_PATH)" \
		--with-openssl \
		--prefix="$(INSTALL_DATA)"
	cd build && make sysconfdir=/opt/prestogres/etc

clean-pgpool2:
	@rm -rf build

install-pgpool2:
	cd build && make install

