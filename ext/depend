# vim: ft=make noexpandtab

# normalize rubyarchdir which is not available depending on rake or gem
narchdir = $(if $(rubyarchdir),$(rubyarchdir),$(RUBYARCHDIR))

# hack for RubyGems >= 1.8.26
final_archdir = $(if $(findstring .gem.,$(narchdir)),$(dir $(narchdir)),$(narchdir))

NATIVE_PREFIX = $(final_archdir)/prestogres
ABS_NATIVE_PREFIX = $(abspath $(NATIVE_PREFIX))

CFLAGS += -DPRESTOGRES_PREFIX="\"$(ABS_NATIVE_PREFIX)\""

all: native
clean: clean-native
install: install-native

PGPOOL2_PATH = $(abspath $(srcdir)/../pgpool2)

native:
	mkdir -p build
	cd build && "$(PGPOOL2_PATH)/configure" \
		CFLAGS="-I$(PGPOOL2_PATH)" \
		--with-openssl \
		--prefix="$(ABS_NATIVE_PREFIX)"
	cd build && make sysconfdir=/opt/prestogres/etc

clean-native:
	@rm -rf build

install-native:
	cd build && make install

.PHONY: native clean-native install-native
